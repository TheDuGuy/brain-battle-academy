// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  name          String    @unique
  email         String?   @unique
  password      String
  avatar        String?
  color         String    @default("#9333EA")
  role          String    @default("PLAYER") // PLAYER, PARENT, or ADMIN
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Parent-child relationship
  parent        User?     @relation("ParentChildren", fields: [parentId], references: [id], onDelete: SetNull)
  parentId      String?
  children      User[]    @relation("ParentChildren")

  sessions      Session[]
  progress      Progress[]
  achievements  Achievement[]
  rewards       Reward[]
  streaks       Streak[]
}

model Session {
  id            String    @id @default(cuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  startTime     DateTime  @default(now())
  endTime       DateTime?
  duration      Int?      // in seconds
  totalQuestions Int      @default(0)
  correctAnswers Int      @default(0)
  accuracy      Float     @default(0)
  subject       String    // Maths, English, Verbal, NonVerbal
  gameType      String    // QuickFire, Calculator, etc
  starsEarned   Int       @default(0)
  completed     Boolean   @default(false)

  answers       Answer[]
}

model Answer {
  id            String    @id @default(cuid())
  sessionId     String
  session       Session   @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  questionId    String
  userAnswer    String
  correctAnswer String
  isCorrect     Boolean
  timeSpent     Int       // in seconds
  createdAt     DateTime  @default(now())
}

model Progress {
  id            String    @id @default(cuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  subject       String
  gameType      String
  level         Int       @default(1)
  totalStars    Int       @default(0)
  gamesPlayed   Int       @default(0)
  bestAccuracy  Float     @default(0)
  lastPlayedAt  DateTime  @default(now())

  // Skill level for difficulty progression (subject-wide, not per-game)
  skillLevel    Int       @default(1)

  @@unique([userId, subject, gameType])
}

model Achievement {
  id            String    @id @default(cuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  type          String    // Badge, Trophy, Milestone
  name          String
  description   String
  icon          String
  earnedAt      DateTime  @default(now())
}

model Reward {
  id            String      @id @default(cuid())
  userId        String
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  type          String      // HIGH_ACCURACY or STREAK
  amountPence   Int         // Store money in pence (100 = Â£1)
  reason        String
  weekStart     DateTime
  createdAt     DateTime    @default(now())

  @@index([userId, weekStart])
  @@index([userId, type, weekStart])
}

model Streak {
  id            String    @id @default(cuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  currentStreak Int       @default(0)
  longestStreak Int       @default(0)
  lastPlayedDate DateTime @default(now())
  weekStart     DateTime  @default(now())

  @@unique([userId, weekStart])
}

model LoginAttempt {
  id            String    @id @default(cuid())
  username      String
  ipAddress     String?
  success       Boolean
  attemptedAt   DateTime  @default(now())

  @@index([username, attemptedAt])
  @@index([ipAddress, attemptedAt])
}

// ============================================================================
// PDF Ingestion & Imported Questions
// ============================================================================

model SourceMaterial {
  id        String   @id @default(cuid())
  title     String
  subject   String   // MATHS, ENGLISH, VR, NVR
  origin    String   // e.g. file path, site name
  createdAt DateTime @default(now())

  questions ImportedQuestion[]
}

model ImportedQuestion {
  id             String          @id @default(cuid())
  source         SourceMaterial  @relation(fields: [sourceId], references: [id], onDelete: Cascade)
  sourceId       String

  number         Int?            // question number in paper
  subject        String          // MATHS, ENGLISH, VR, NVR
  type           String          // MULTIPLE_CHOICE, SHORT_ANSWER, SYNONYM, COMPREHENSION, NUMERIC
  gameTags       String          // JSON array of game tags ["QUIZ_MASTER","SYNONYM_FINDER",etc]

  prompt         String          // main question text
  optionsJson    String?         // JSON array for MCQ options
  answer         String?         // correct answer if known
  explanation    String?         // optional explanation
  metadataJson   String?         // raw / extra info (page, original format, etc.)

  createdAt      DateTime @default(now())

  @@index([subject, type])
  @@index([sourceId])
}
